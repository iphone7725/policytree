<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>policytree introduction • policytree</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="policytree introduction">
<meta property="og:description" content="policytree">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">policytree</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.9.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/policytree.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../CHANGELOG.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/grf-labs/policytree">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="policytree_files/htmlwidgets-1.5.1/htmlwidgets.js"></script><script src="policytree_files/viz-1.8.2/viz.js"></script><link href="policytree_files/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="policytree_files/grViz-binding-1.0.5/grViz.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>policytree introduction</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/grf-labs/policytree/blob/master/vignettes/policytree.Rmd"><code>vignettes/policytree.Rmd</code></a></small>
      <div class="hidden name"><code>policytree.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">policytree</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">grf</span>)</pre></body></html></div>
<div id="binary-treatment-effect-estimation-and-policy-learning" class="section level1">
<h1 class="hasAnchor">
<a href="#binary-treatment-effect-estimation-and-policy-learning" class="anchor"></a>Binary treatment effect estimation and policy learning</h1>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">n</span> <span class="kw">&lt;-</span> <span class="fl">10000</span>
<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fl">10</span>

<span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n</span> * <span class="no">p</span>), <span class="no">n</span>, <span class="no">p</span>)
<span class="no">ee</span> <span class="kw">&lt;-</span> <span class="fl">1</span> / (<span class="fl">1</span> + <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="no">X</span>[, <span class="fl">3</span>]))
<span class="no">tt</span> <span class="kw">&lt;-</span> <span class="fl">1</span> / (<span class="fl">1</span> + <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>((<span class="no">X</span>[, <span class="fl">1</span>] + <span class="no">X</span>[, <span class="fl">2</span>]) / <span class="fl">2</span>)) - <span class="fl">0.5</span>
<span class="no">W</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="no">n</span>, <span class="fl">1</span>, <span class="no">ee</span>)
<span class="no">Y</span> <span class="kw">&lt;-</span> <span class="no">X</span>[, <span class="fl">3</span>] + <span class="no">W</span> * <span class="no">tt</span> + <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n</span>)

<span class="no">cf</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/grf/man/causal_forest.html">causal_forest</a></span>(<span class="no">X</span>, <span class="no">Y</span>, <span class="no">W</span>)

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">tt</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">cf</span>)$<span class="no">predictions</span>)</pre></body></html></div>
<p><img src="policytree_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<div class="sourceCode" id="cb3"><html><body><pre class="r">
<span class="no">dr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/double_robust_scores.html">double_robust_scores</a></span>(<span class="no">cf</span>)
<span class="no">tree</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/policy_tree.html">policy_tree</a></span>(<span class="no">X</span>, <span class="no">dr</span>, <span class="fl">2</span>)
<span class="no">tree</span>
<span class="co">#&gt; policy_tree object </span>
<span class="co">#&gt; Tree depth:  2 </span>
<span class="co">#&gt; Actions:  1: control 2: treated </span>
<span class="co">#&gt; Variable splits: </span>
<span class="co">#&gt; (1) split_variable: X2  split_value: -0.287989 </span>
<span class="co">#&gt;   (2) split_variable: X1  split_value: 1.40486 </span>
<span class="co">#&gt;     (4) * action: 2 </span>
<span class="co">#&gt;     (5) * action: 1 </span>
<span class="co">#&gt;   (3) split_variable: X1  split_value: -0.729217 </span>
<span class="co">#&gt;     (6) * action: 2 </span>
<span class="co">#&gt;     (7) * action: 1</span>
<span class="no">pp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">tree</span>, <span class="no">X</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span>(<span class="no">tt</span> ~ <span class="no">pp</span>)</pre></body></html></div>
<p><img src="policytree_files/figure-html/unnamed-chunk-2-2.png" width="700"></p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">tree</span>)</pre></body></html></div>
<div id="htmlwidget-160cfec27b6c02cc8d33" style="width:700px;height:432.632880098888px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-160cfec27b6c02cc8d33">{"x":{"diagram":"digraph nodes { \n node [shape=box] ;\n0 [label=\" X2 <= -0.29 \"] ;\n0 -> 1 [labeldistance=2.5, labelangle=45, headlabel=\"True\"];\n0 -> 2 [labeldistance=2.5, labelangle=-45, headlabel=\"False\"]\n1 [label=\" X1 <= 1.4 \"] ;\n1 -> 3  ;\n1 -> 4  ;\n3  [shape=box,style=filled,color=\".7 .3 1.0\" , label=\"leaf node \n      action =  2 \"];\n4  [shape=box,style=filled,color=\".7 .3 1.0\" , label=\"leaf node \n      action =  1 \"];\n2 [label=\" X1 <= -0.73 \"] ;\n2 -> 5  ;\n2 -> 6  ;\n5  [shape=box,style=filled,color=\".7 .3 1.0\" , label=\"leaf node \n      action =  2 \"];\n6  [shape=box,style=filled,color=\".7 .3 1.0\" , label=\"leaf node \n      action =  1 \"];\n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script><div class="sourceCode" id="cb5"><html><body><pre class="r">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">X</span>[, <span class="fl">1</span>], <span class="no">X</span>[, <span class="fl">2</span>], <span class="kw">col</span> <span class="kw">=</span> <span class="no">pp</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="fl">0</span>, -<span class="fl">1</span>, <span class="kw">lwd</span> <span class="kw">=</span> <span class="fl">4</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fl">4</span>)</pre></body></html></div>
<p><img src="policytree_files/figure-html/unnamed-chunk-2-4.png" width="700"></p>
</div>
<div id="multi-action-treatment-effect-estimation-zhou-athey-and-wager-2018" class="section level1">
<h1 class="hasAnchor">
<a href="#multi-action-treatment-effect-estimation-zhou-athey-and-wager-2018" class="anchor"></a>Multi-action treatment effect estimation (Zhou, Athey and Wager, 2018)</h1>
<p>The following example is from the 3-action DGP from section 6.4.1 in <a href="https://arxiv.org/abs/1810.04778">Zhou, Athey and Wager (2018)</a></p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">n</span> <span class="kw">&lt;-</span> <span class="fl">10000</span>
<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fl">10</span>
<span class="no">data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/gen_data_mapl.html">gen_data_mapl</a></span>(<span class="no">n</span>, <span class="no">p</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">data</span>)[<span class="fl">1</span>:<span class="fl">6</span>])
<span class="co">#&gt;   action          Y        X.1       X.2       X.3        X.4</span>
<span class="co">#&gt; 1      1  2.6284326 0.67222112 0.1911761 0.8306201 0.04823820</span>
<span class="co">#&gt; 2      2 -0.4104820 0.06268746 0.5293111 0.9005144 0.17141539</span>
<span class="co">#&gt; 3      0  2.5760171 0.96091759 0.2426804 0.8510604 0.81590389</span>
<span class="co">#&gt; 4      1  6.4251811 0.28812068 0.5097512 0.2848444 0.26683712</span>
<span class="co">#&gt; 5      1 -0.7418237 0.24016147 0.9975204 0.5635440 0.29509120</span>
<span class="co">#&gt; 6      2 -0.1215063 0.12274854 0.8569016 0.4839027 0.09840055</span>

<span class="no">X</span> <span class="kw">&lt;-</span> <span class="no">data</span>$<span class="no">X</span>
<span class="no">Y</span> <span class="kw">&lt;-</span> <span class="no">data</span>$<span class="no">Y</span>
<span class="no">W</span> <span class="kw">&lt;-</span> <span class="no">data</span>$<span class="no">action</span>

<span class="no">multi.forest</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/multi_causal_forest.html">multi_causal_forest</a></span>(<span class="no">X</span>, <span class="no">Y</span>, <span class="no">W</span>)

<span class="co"># tau.hats:</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">multi.forest</span>)$<span class="no">predictions</span>)
<span class="co">#&gt;              0         1          2</span>
<span class="co">#&gt; 1  1.150042304 0.3273936 -1.4269079</span>
<span class="co">#&gt; 2 -0.004364479 0.2933084 -0.6225474</span>
<span class="co">#&gt; 3 -2.245999992 0.1344773  1.7661422</span>
<span class="co">#&gt; 4 -1.679664738 0.2670025  0.4515250</span>
<span class="co">#&gt; 5  1.137334378 0.1815248 -1.2724332</span>
<span class="co">#&gt; 6  1.116785345 0.3329515 -1.1942411</span>

<span class="co"># Each region with optimal action</span>
<span class="no">region.pp</span> <span class="kw">&lt;-</span> <span class="no">data</span>$<span class="no">region</span> + <span class="fl">1</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">X</span>[, <span class="fl">5</span>], <span class="no">X</span>[, <span class="fl">7</span>], <span class="kw">col</span> <span class="kw">=</span> <span class="no">region.pp</span>)
<span class="no">leg</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">region.pp</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span>(<span class="st">"topleft"</span>, <span class="kw">legend</span> <span class="kw">=</span> <span class="no">leg</span> - <span class="fl">1</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="no">leg</span>, <span class="kw">pch</span> <span class="kw">=</span> <span class="fl">10</span>)</pre></body></html></div>
<p><img src="policytree_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div id="policy-learning" class="section level3">
<h3 class="hasAnchor">
<a href="#policy-learning" class="anchor"></a>Policy learning</h3>
<p>Cross-fitted Augmented Inverse Propensity Weighted Learning (CAIPWL) with the optimal depth 2 tree</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">Gamma.matrix</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/double_robust_scores.html">double_robust_scores</a></span>(<span class="no">multi.forest</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">Gamma.matrix</span>)
<span class="co">#&gt;           0         1         2</span>
<span class="co">#&gt; 1 2.9843125  2.930553  0.947740</span>
<span class="co">#&gt; 2 2.0604241  2.193199 -6.660060</span>
<span class="co">#&gt; 3 8.6325852  1.545540  2.673770</span>
<span class="co">#&gt; 4 0.1508738 11.346644  1.771610</span>
<span class="co">#&gt; 5 2.9890507 -2.760374  1.070993</span>
<span class="co">#&gt; 6 2.7453416  1.991774 -3.734485</span>

<span class="no">train</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">1</span>:<span class="no">n</span>, <span class="fl">9000</span>)
<span class="no">opt.tree</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/policy_tree.html">policy_tree</a></span>(<span class="no">X</span>[<span class="no">train</span>, ], <span class="no">Gamma.matrix</span>[<span class="no">train</span>, ], <span class="kw">depth</span> <span class="kw">=</span> <span class="fl">2</span>)
<span class="no">opt.tree</span>
<span class="co">#&gt; policy_tree object </span>
<span class="co">#&gt; Tree depth:  2 </span>
<span class="co">#&gt; Actions:  1: 0 2: 1 3: 2 </span>
<span class="co">#&gt; Variable splits: </span>
<span class="co">#&gt; (1) split_variable: X5  split_value: 0.601712 </span>
<span class="co">#&gt;   (2) split_variable: X7  split_value: 0.35235 </span>
<span class="co">#&gt;     (4) * action: 3 </span>
<span class="co">#&gt;     (5) * action: 1 </span>
<span class="co">#&gt;   (3) split_variable: X7  split_value: 0.713839 </span>
<span class="co">#&gt;     (6) * action: 2 </span>
<span class="co">#&gt;     (7) * action: 3</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">opt.tree</span>)</pre></body></html></div>
<div id="htmlwidget-67b6fd1412a1ba1057cb" style="width:700px;height:432.632880098888px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-67b6fd1412a1ba1057cb">{"x":{"diagram":"digraph nodes { \n node [shape=box] ;\n0 [label=\" X5 <= 0.6 \"] ;\n0 -> 1 [labeldistance=2.5, labelangle=45, headlabel=\"True\"];\n0 -> 2 [labeldistance=2.5, labelangle=-45, headlabel=\"False\"]\n1 [label=\" X7 <= 0.35 \"] ;\n1 -> 3  ;\n1 -> 4  ;\n3  [shape=box,style=filled,color=\".7 .3 1.0\" , label=\"leaf node \n      action =  3 \"];\n4  [shape=box,style=filled,color=\".7 .3 1.0\" , label=\"leaf node \n      action =  1 \"];\n2 [label=\" X7 <= 0.71 \"] ;\n2 -> 5  ;\n2 -> 6  ;\n5  [shape=box,style=filled,color=\".7 .3 1.0\" , label=\"leaf node \n      action =  2 \"];\n6  [shape=box,style=filled,color=\".7 .3 1.0\" , label=\"leaf node \n      action =  3 \"];\n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script><p>Predict treatment on held out data</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">X.test</span> <span class="kw">&lt;-</span> <span class="no">X</span>[-<span class="no">train</span>, ]
<span class="no">pp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">opt.tree</span>, <span class="no">X.test</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">pp</span>)
<span class="co">#&gt; [1] 2 3 1 1 2 2</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">X.test</span>[, <span class="fl">5</span>], <span class="no">X.test</span>[, <span class="fl">7</span>], <span class="kw">col</span> <span class="kw">=</span> <span class="no">pp</span>)
<span class="no">leg</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">pp</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span>(<span class="st">"topleft"</span>, <span class="kw">legend</span> <span class="kw">=</span> <span class="no">leg</span> - <span class="fl">1</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="no">leg</span>, <span class="kw">pch</span> <span class="kw">=</span> <span class="fl">10</span>)</pre></body></html></div>
<p><img src="policytree_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
</div>
</div>
<div id="efficient-policy-learning---binary-treatment-and-instrumental-variables-wager-and-athey-2017" class="section level1">
<h1 class="hasAnchor">
<a href="#efficient-policy-learning---binary-treatment-and-instrumental-variables-wager-and-athey-2017" class="anchor"></a>Efficient Policy Learning - Binary Treatment and Instrumental Variables (Wager and Athey, 2017)</h1>
<p>The following example is from section 5.2 in <a href="https://arxiv.org/abs/1702.02896">Wager and Athey (2017)</a>.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">n</span> <span class="kw">&lt;-</span> <span class="fl">500</span>
<span class="no">data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/gen_data_epl.html">gen_data_epl</a></span>(<span class="no">n</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"continuous"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">data</span>))[<span class="fl">1</span>:<span class="fl">6</span>]
<span class="co">#&gt;   W Z         tau          Y         X.1         X.2</span>
<span class="co">#&gt; 1 0 1 -0.50000000  3.4662060 -0.13701966 -1.59064506</span>
<span class="co">#&gt; 2 1 1 -0.07788149  0.5532977 -0.84836207  0.84423702</span>
<span class="co">#&gt; 3 0 0  0.17925500  1.4832753  1.02471100  0.33379899</span>
<span class="co">#&gt; 4 0 1 -0.50000000  1.1881457 -0.04921944 -0.85043640</span>
<span class="co">#&gt; 5 1 1  0.09894633  3.1677820  0.32794872  0.86994393</span>
<span class="co">#&gt; 6 0 1 -0.45727715 -0.6397086 -0.79551953  0.08544569</span>

<span class="no">iv.forest</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/grf/man/instrumental_forest.html">instrumental_forest</a></span>(<span class="kw">X</span> <span class="kw">=</span> <span class="no">data</span>$<span class="no">X</span>, <span class="kw">Y</span> <span class="kw">=</span> <span class="no">data</span>$<span class="no">Y</span>, <span class="kw">W</span> <span class="kw">=</span> <span class="no">data</span>$<span class="no">W</span>, <span class="kw">Z</span> <span class="kw">=</span> <span class="no">data</span>$<span class="no">Z</span>)

<span class="no">gamma</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/double_robust_scores.html">double_robust_scores</a></span>(<span class="no">iv.forest</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">gamma</span>)
<span class="co">#&gt;         control    treated</span>
<span class="co">#&gt; [1,] -2.4074811  2.4074811</span>
<span class="co">#&gt; [2,] -0.9621055  0.9621055</span>
<span class="co">#&gt; [3,]  0.5835709 -0.5835709</span>
<span class="co">#&gt; [4,] -0.7737124  0.7737124</span>
<span class="co">#&gt; [5,] -2.7940823  2.7940823</span>
<span class="co">#&gt; [6,]  4.4812330 -4.4812330</span></pre></body></html></div>
<p>Find the depth-2 tree which solves (2):</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">train</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">1</span>:<span class="fl">400</span>)
<span class="no">tree</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/policy_tree.html">policy_tree</a></span>(<span class="no">data</span>$<span class="no">X</span>[<span class="no">train</span>, ], <span class="no">gamma</span>[<span class="no">train</span>, ])
<span class="no">tree</span>
<span class="co">#&gt; policy_tree object </span>
<span class="co">#&gt; Tree depth:  2 </span>
<span class="co">#&gt; Actions:  1: control 2: treated </span>
<span class="co">#&gt; Variable splits: </span>
<span class="co">#&gt; (1) split_variable: X4  split_value: 0.169516 </span>
<span class="co">#&gt;   (2) split_variable: X1  split_value: 0.503502 </span>
<span class="co">#&gt;     (4) * action: 1 </span>
<span class="co">#&gt;     (5) * action: 2 </span>
<span class="co">#&gt;   (3) split_variable: X1  split_value: -0.389985 </span>
<span class="co">#&gt;     (6) * action: 2 </span>
<span class="co">#&gt;     (7) * action: 1</span></pre></body></html></div>
<p>Evaluate the policy on held out data:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">piX</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">tree</span>, <span class="no">data</span>$<span class="no">X</span>[-<span class="no">train</span>, ]) - <span class="fl">1</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">piX</span>)
<span class="co">#&gt; [1] 1 1 1 1 1 0</span>

<span class="no">reward.policy</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>((<span class="fl">2</span> * <span class="no">piX</span> - <span class="fl">1</span>) * <span class="no">data</span>$<span class="no">tau</span>[-<span class="no">train</span>])
<span class="no">reward.policy</span>
<span class="co">#&gt; [1] 0.1524301</span></pre></body></html></div>
</div>
<div id="gauging-the-runtime-of-tree-search" class="section level1">
<h1 class="hasAnchor">
<a href="#gauging-the-runtime-of-tree-search" class="anchor"></a>Gauging the runtime of tree search</h1>
<p>The amortized runtime of the exact tree search is <span class="math inline">\(O(p^k n^k (log n + d) + pnlog n)\)</span> where <span class="math inline">\(p\)</span> is the number of features, <span class="math inline">\(d\)</span> the number of treatments, <span class="math inline">\(n\)</span> the number of observations, and <span class="math inline">\(k \geq 1\)</span> the tree depth.</p>
<p>For a depth two tree this is <span class="math inline">\(O(p^2 n^2 (log n + d))\)</span> (ignoring the last term which is a global sort done at the beginning) meaning that it scales quadratically with the number of observations, i.e. if you double the number of observations, the search will take at least four times as long.</p>
<p>For a depth three tree it is <span class="math inline">\(O(p^3 n^3 (log n + d))\)</span>. If a depth two tree with 1000 observations, 4 features and 3 actions took around t seconds, you can expect the level three tree to take approximately <span class="math inline">\(1000\cdot 4\)</span> times as long (<span class="math inline">\(\approx\frac{p^3n^2}{p^2n^2}=pn\)</span>)</p>
<p>The runtime above is with continuous features. There are considerable time savings when the features are discrete. In the extreme case with all binary observations, the runtime will be practically linear in n.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Zhengyuan Zhou, Susan Athey, Stefan Wager, Ayush Kanodia, Erik Sverdrup.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.0.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
